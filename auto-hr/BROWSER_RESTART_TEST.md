# 浏览器重启状态持久化测试指南

## 🧪 测试步骤

### 1. 初始设置测试
1. 打开Chrome浏览器，加载扩展
2. 打开扩展弹窗
3. 选择一个非默认的模板（如"专业模板"）
4. 添加一个自定义模板：
   - 点击"➕ 添加模板"
   - 输入名称："测试模板"
   - 输入内容："这是一个测试消息模板，用于验证浏览器重启后的状态保持。"
   - 点击"保存模板"

### 2. 状态验证测试
1. 确认当前选中的是刚创建的"测试模板"
2. 双击标题"🤖 HR自动化助手"打开存储调试
3. 在控制台查看存储数据，确认：
   - `config.autoReply.selectedTemplateId` 为自定义模板ID
   - `messageTemplates` 包含自定义模板
   - `uiState` 包含UI状态

### 3. 重启前验证
1. 记录当前状态：
   - 选中的模板名称
   - 自定义模板的数量
   - 申请人数据数量
2. 关闭扩展弹窗

### 4. 浏览器重启测试
1. **完全关闭Chrome浏览器**（不是最小化）
2. **重新启动Chrome浏览器**
3. 打开扩展弹窗

### 5. 状态恢复验证
✅ 应该保持的状态：
- [ ] 模板选择器显示之前选中的"测试模板"
- [ ] 自定义模板仍然存在
- [ ] 模板预览区显示正确的内容
- [ ] 申请人数据计数保持不变
- [ ] 如果之前表单是展开状态，应该保持展开

## 🔍 调试功能

### 存储调试
- **双击标题**可查看存储调试信息
- 控制台会显示所有存储数据
- 包括存储读写测试结果

### 手动存储测试
在控制台中运行：
```javascript
// 测试存储功能
window.storageDebug.testStorage()

// 查看所有存储数据
window.storageDebug.logAllData()

// 清理损坏的数据
window.storageDebug.cleanupStorage()
```

## 📊 预期结果

### ✅ 成功标准
1. **模板状态**: 重启后选中的模板与重启前完全一致
2. **自定义模板**: 所有自定义模板都完整保存
3. **UI状态**: 表单展开状态、输入内容等UI状态保持
4. **数据完整性**: 申请人数据、配置等都完整保存
5. **加载时间**: 重启后打开扩展，状态恢复应该很快（<200ms）

### ❌ 失败情况
如果出现以下情况，说明持久化有问题：
- 重启后默认选中第一个模板
- 自定义模板丢失
- UI状态重置（如表单收起）
- 申请人数据清零

## 🛠️ 故障排除

### 如果状态没有保持：
1. 检查Chrome扩展权限中是否包含"存储"
2. 在控制台运行 `window.storageDebug.testStorage()` 测试存储功能
3. 查看控制台是否有错误信息
4. 确认使用的是生产版本，不是开发版本

### 存储数据损坏时：
1. 运行 `window.storageDebug.cleanupStorage()` 清理损坏数据
2. 重新设置模板和配置
3. 再次测试重启

## 📝 技术实现细节

### 存储机制
- 使用 `chrome.storage.local` API
- 数据存储在用户的Chrome配置文件中
- 支持跨浏览器会话持久化

### 存储的数据类型
- `config`: 扩展配置（包含选中的模板ID）
- `messageTemplates`: 自定义模板列表
- `uiState`: UI状态（表单展开状态、输入内容）
- `applicants`: 申请人数据
- `batchProcessing`: 批量处理状态
- `scanProcessing`: 扫描处理状态

### 数据恢复流程
1. 扩展启动时自动读取存储数据
2. 验证数据完整性和有效性
3. 如果数据损坏，自动使用默认值
4. 将状态应用到UI组件